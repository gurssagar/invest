var pe=Object.defineProperty;var re=Object.getOwnPropertySymbols;var he=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable;var oe=(i,e,t)=>e in i?pe(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,C=(i,e)=>{for(var t in e||(e={}))he.call(e,t)&&oe(i,t,e[t]);if(re)for(var t of re(e))me.call(e,t)&&oe(i,t,e[t]);return i};var d=(i,e,t)=>new Promise((s,n)=>{var a=p=>{try{u(t.next(p))}catch(f){n(f)}},l=p=>{try{u(t.throw(p))}catch(f){n(f)}},u=p=>p.done?s(p.value):Promise.resolve(p.value).then(a,l);u((t=t.apply(i,e)).next())});import{ClientRequest as Re}from"http";import y from"picocolors";import{URL as de}from"url";import ue from"clean-css";var W=class{constructor(e,t,s,n){this.options=e;this.logger=t;this.downloader=s;this.fileCache=n;this.isRelativeUrlRegex=/\.\.?\/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi;this.protocolRelativeUrlRegex=new RegExp("(?<!https?:)\\/\\/[-a-z0-9@:%_+.~#?&/=]+\\.(?:woff2?|eot|ttf|otf|svg)","gi")}loadAll(e,t){return d(this,null,function*(){let s="";for(let n of e){let a=yield this.load(n),l=this.normalizeUrls(a.trim(),n);s+=l+`
`}return this.formatCss(s,t)})}formatCss(e,t){return!t&&this.options.minifyCss?this.minify(e):e.trim()}minify(e){return new ue().minify(e).styles}normalizeUrls(e,t){return e=e.replaceAll(this.isRelativeUrlRegex,s=>new de(s,t).href),e=e.replaceAll(this.protocolRelativeUrlRegex,s=>"https:"+s),e}load(e){return d(this,null,function*(){this.logger.flashLine(e);let t=this.fileCache.get("css",e);if(t)return t;let s=yield this.downloader.download(e,"text");return this.fileCache.save("css",e,s.data),s.data})}};var M=class{constructor(){this.fontSrcRegex=/(?:https?:)?\/\/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi;this.googleFontsKitSrcRegex=/https:\/\/fonts\.gstatic\.com\/l\/font\?kit=[a-z0-9&=_-]+/gi;this.fontFilenameRegex=/[^/]+\.(?:woff2?|eot|ttf|otf|svg)/i;this.googleFontsFileRegex=/\?kit=([a-z0-9_-]+)/i;this.webfontProviders=[/https:\/\/fonts\.googleapis\.com\//i,/https:\/\/fonts\.gstatic\.com\//i,/https:\/\/fonts\.bunny\.net\//i,/https:\/\/api\.fontshare\.com\//i]}parse(e,t,s){var u,p;let n={},a=e.matchAll(this.fontSrcRegex),l=e.matchAll(this.googleFontsKitSrcRegex);if(a)for(let f of a){let b=f.toString(),h=b.match(this.fontFilenameRegex);if(h){let w=h[0];n[w]={url:b,localPath:t+(s?s+"/":"")+w}}}if(l)for(let f of l){let b=f.toString(),h=(p=(u=b.match(this.googleFontsFileRegex))==null?void 0:u[1])==null?void 0:p.toString();h&&(n[h+".woff2"]={url:b,localPath:t+(s?s+"/":"")+h+".woff2"})}return n}parseBundleCss(e,t,s){let n={},a=new Set([]),l=[],u=/@import\s*(?:url\()?['"]?([^\s'"]+)['"]?\)?;/g,p=/@font-face\s*{[^}]*}/g,f=[...e.matchAll(u)];return[...e.matchAll(p)].forEach(h=>{let w=h[0],F=this.parse(w,t,s);for(let P in F){let O=F[P];this.webfontProviders.some(D=>D.test(O.url))&&(n[P]=O,l.push(h[0]))}}),f.forEach(h=>{let w=h[1];this.webfontProviders.some(F=>F.test(w))&&(a.add(w),l.push(h[0]))}),{fonts:n,webfontUrlsCss:a,matchedCssParts:l}}};var j=class{constructor(e){this.options=e}injectAsStylesheet(e,t,s){return this.options.async?this.injectAsync(e,t,s):this.injectSync(e,t,s)}injectAsStyleTag(e,t){return this.options.minifyCss?e.replace(/(\n?)([ \t]*)<\/head>/,`$1$2$2<style>${t}</style>$1$2</head>`):e.replace(/([ \t]*)<\/head>/,`$1$1<style>
${t.replace(/^/gm,"$1$1$1")}
$1$1</style>
$1</head>`)}injectAsync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" media="print" onload="this.onload=null;this.removeAttribute('media');" href="${t}${s}">
$1</head>`)}injectSync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" href="${t}${s}">
$1</head>`)}};var z=class{transform(e,t){for(let s in t){let n=t[s];e=e.replaceAll(n.url,n.localPath)}return e}};import{Axios as ve,isAxiosError as ye}from"axios";import{Agent as we}from"http";import{Agent as be}from"https";import E from"picocolors";var H=class{constructor(e,t){this.options=e;this.logger=t;this.userAgentWoff2="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36";this.maxTries=3;this.timeout=2500;this.waitBeforeRetry=[25,2500];this.axios=new ve({timeout:this.timeout,proxy:this.options.proxy,httpAgent:new we({keepAlive:!0,family:4}),httpsAgent:new be({keepAlive:!0,family:4})})}download(e,t,s=1){return d(this,null,function*(){try{let n=yield this.toRequest(e,t);return s>1&&this.logger.info(E.green(`\u2713 ${e}`)+" "+E.dim(`(try #${s})`)),n}catch(n){if(this.logger.error(E.red(`\u2717 ${e}`)+" "+E.dim(`(try #${s})`)+": "+(ye(n)?n.message:n)),s<this.maxTries)return yield new Promise(a=>setTimeout(a,this.randomWaitInterval())),this.download(e,t,s+1);throw n}})}toRequest(e,t){return this.axios.get(e,{headers:{"User-Agent":this.userAgentWoff2},responseType:t||"arraybuffer"})}randomWaitInterval(){return Math.floor(Math.random()*(this.waitBeforeRetry[0]-this.waitBeforeRetry[1]+1)+this.waitBeforeRetry[1])}};var U=class{constructor(e,t,s){this.logger=e;this.downloader=t;this.fileCache=s}load(e){return d(this,null,function*(){this.logger.flashLine(e);let t=this.fileCache.get("font",e);if(t)return t;let s=yield this.downloader.download(e);return this.fileCache.save("font",e,s.data),s.data})}};import I from"flat-cache";var K=class{constructor(e){this.enabled=!0;this.hits={css:0,font:0};e.cache===!1&&(this.enabled=!1),this.storeCss=I.create("vite-plugin-webfont-dl__css"),this.storeFont=I.create("vite-plugin-webfont-dl__font"),this.enabled||this.clear()}get(e,t){if(!this.enabled)return;let s=e==="css"?this.storeCss.getKey(t):this.storeFont.getKey(t);if(s)return e==="css"?this.hits.css++:this.hits.font++,s.type!==void 0?Buffer.from(s.data):s}save(e,t,s){this.enabled&&(e==="css"?(this.storeCss.setKey(t,s),this.storeCss.save(!0)):(this.storeFont.setKey(t,s),this.storeFont.save(!0)))}clear(){I.clearCacheById("vite-plugin-webfont-dl__css"),I.clearCacheById("vite-plugin-webfont-dl__font")}};var q=class{constructor(){this.webfontRegexes=[/<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\/\/fonts\.googleapis\.com[^'">]+)['"]?[^>]*>/g,/<link[^>]+href=['"]?(https:\/\/fonts\.googleapis\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>/g,/<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\/\/fonts\.bunny\.net[^'">]+)['"]?[^>]*>/g,/<link[^>]+href=['"]?(https:\/\/fonts\.bunny\.net[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>/g,/<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\/\/api\.fontshare\.com[^'">]+)['"]?[^>]*>/g,/<link[^>]+href=['"]?(https:\/\/api\.fontshare\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>/g];this.preconnectRegexes=[/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/]}parse(e){let t=new Set;for(let s of this.webfontRegexes){let n=e.matchAll(s);if(n)for(let a of n)t.add(a[1])}return t}removeTags(e){return e=this.removePreconnectTags(e),e=this.removeWebfontTags(e),e}removePreconnectTags(e){for(let t of this.preconnectRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}removeWebfontTags(e){for(let t of this.webfontRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}};import{env as xe,stdout as $}from"process";import Ce from"picocolors";var N=class{setResolvedLogger(e){this.resolvedLogger=e}isTty(){return $.isTTY&&!xe.CI}info(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.info((t?this.prefix():"")+e)}error(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.error((t?this.prefix():"")+e)}clearLine(){this.isTty()&&($.clearLine(0),$.cursorTo(0))}flashLine(e,t=!0){this.isTty()?(this.clearLine(),e=(t?this.prefix():"")+e,e.length<$.columns?$.write(e):$.write(e.substring(0,$.columns-1)),this.flashTimeout&&clearTimeout(this.flashTimeout),this.flashTimeout=setTimeout(()=>{this.clearLine()},500)):this.info(e,t)}prefix(){return Ce.dim("[webfont-dl] ")}};var Fe={injectAsStyleTag:!0,minifyCss:!0,async:!0,cache:!0,proxy:!1},ne=(i={})=>C(C({},Fe),i);import{AxiosError as Ae}from"axios";function ht(i,e){!Array.isArray(i)&&typeof i!="string"&&(i=[]),typeof i=="string"&&i!==""&&(i=[i]);let t=new Set(i||[]),s=new Set([]),n=new Set([]),a=ne(e),l={},u="webfonts.css",p=new Map,f=new N,b=new H(a,f),h=new K(a),w=new W(a,f,b,h),F=new M,P=new z,O=new j(a),D=new U(f,b,h),V=new q,x,_,L,R,S,v="",k,B=new Map,X=r=>{for(let o of V.parse(r))s.add(o)},ie=()=>{s.clear(),B.forEach(r=>{X(r)})},ae=r=>{n.clear();for(let o in r)if(o.match(/\.css$/)){let g=r[o].source.toString(),m=F.parseBundleCss(g,R,S);m.matchedCssParts.length&&(l=C(C({},l),m.fonts),m.webfontUrlsCss.forEach(c=>{n.add(c)}),m.matchedCssParts.forEach(c=>{g=g.replaceAll(c,""),v+=c+`
`}),r[o].source=g,v=w.formatCss(v,!!x))}},G=()=>d(this,null,function*(){v="";let r=Date.now(),o=new Set([...t,...s,...n]);return o.size&&(v+=yield w.loadAll(o,!!x)),x||f.info(y.green("\u2713")+" "+o.size.toString()+" webfont css downloaded. "+y.dim("("+y.bold(ee(r))+", "+(a.cache!==!1?`cache hit: ${y.bold(te(h.hits.css,o.size))}`:"cache disabled")+")"),!1),v}),Y=r=>{l=C(C({},l),F.parse(r,R,S))},J=()=>{v=P.transform(v,l)},le=()=>d(this,null,function*(){let r=Date.now();for(let o in l){let g=l[o],m=yield D.load(g.url);g.localPath=R+Q(o,m)}f.info(y.green("\u2713")+" "+Object.keys(l).length.toString()+" webfonts downloaded. "+y.dim("("+y.bold(ee(r))+", "+(a.cache!==!1?`cache hit: ${y.bold(te(h.hits.font,Object.keys(l).length))}`:"cache disabled")+")"),!1)}),ce=r=>d(this,null,function*(){let o=D.load(r);return f.clearLine(),o}),fe=()=>d(this,null,function*(){Y(yield G()),J(),p.clear();for(let r in l){let o=l[r];p.set(o.localPath,o.url)}}),ge=()=>{k=Q(u,v)},Q=(r,o)=>{let g=_.emitFile({name:r,type:"asset",source:o});return _.getFileName(g)},Z=(r,o)=>x||a.injectAsStyleTag===!1?O.injectAsStylesheet(r,R,k):O.injectAsStyleTag(r,o),ee=r=>(Date.now()-r).toLocaleString()+" ms",te=(r,o)=>(Math.round(r/o*100*100)/100).toFixed(2)+"%";return{name:"vite-plugin-webfont-dl",enforce:"post",configResolved(r){L=r,R=L.base,S=L.build.assetsDir,k=S+"/"+u,L.build.minify===!1&&(e==null?void 0:e.minifyCss)!==!0&&(a.minifyCss=!1),f.setResolvedLogger(L.logger)},configureServer(r){x=r,S="@webfonts",k=S+"/"+u;let o=(m,c)=>{d(this,null,function*(){c.setHeader("Content-Type","text/css");try{yield fe(),c.end(v)}catch(A){f.error(y.red(A.message)),c.statusCode=502,c.setHeader("X-Error",A.message.replace(/^Error: /,"")),c.end()}})},g=(m,c)=>{d(this,null,function*(){var T;let A=(T=m.originalUrl)==null?void 0:T.replace(/[?#].*$/,"");c.setHeader("Access-Control-Allow-Origin","*"),c.end(yield ce(p.get(A)))})};x.middlewares.use(R+k,o),x.middlewares.use(R+u,o),x.middlewares.use((m,c,A)=>{var se;let T=(se=m.originalUrl)==null?void 0:se.replace(/[?#].*$/,"");if(!T)return A();T.match(/\.(?:woff2?|eot|ttf|otf|svg)$/)&&p.has(T)?g(m,c):A()})},transformIndexHtml(r,o){return B.set(o.path.replace(/^\//,""),r),x&&(s.clear(),X(r),r=V.removeTags(r),r=Z(r)),r},generateBundle(r,o){return d(this,null,function*(){_=this,ie(),ae(o);try{Y(yield G()),yield le(),J(),(a.injectAsStyleTag===!1||!B.size)&&ge(),B.forEach((g,m)=>{let c=o[m];c!==void 0&&(c.source=V.removeTags(c.source),c.source=Z(c.source,v),B.set(m,c.source))})}catch(g){f.error(y.red(g.message)),g instanceof Ae&&g.request instanceof Re&&f.error(y.red(`${g.request.method} ${g.request.protocol}//${g.request.host}${g.request.path}`))}})}}}export{ht as ViteWebfontDownload,ht as default,ht as viteWebfontDl,ht as viteWebfontDownload,ht as webfontDl,ht as webfontDownload};
