"use strict";var Re=Object.create;var P=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames,ie=Object.getOwnPropertySymbols,Se=Object.getPrototypeOf,le=Object.prototype.hasOwnProperty,Te=Object.prototype.propertyIsEnumerable;var ae=(r,e,t)=>e in r?P(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,F=(r,e)=>{for(var t in e||(e={}))le.call(e,t)&&ae(r,t,e[t]);if(ie)for(var t of ie(e))Te.call(e,t)&&ae(r,t,e[t]);return r};var Oe=(r,e)=>{for(var t in e)P(r,t,{get:e[t],enumerable:!0})},ce=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $e(e))!le.call(r,n)&&n!==t&&P(r,n,{get:()=>e[n],enumerable:!(s=Ae(e,n))||s.enumerable});return r};var D=(r,e,t)=>(t=r!=null?Re(Se(r)):{},ce(e||!r||!r.__esModule?P(t,"default",{value:r,enumerable:!0}):t,r)),Le=r=>ce(P({},"__esModule",{value:!0}),r);var d=(r,e,t)=>new Promise((s,n)=>{var a=p=>{try{u(t.next(p))}catch(f){n(f)}},l=p=>{try{u(t.throw(p))}catch(f){n(f)}},u=p=>p.done?s(p.value):Promise.resolve(p.value).then(a,l);u((t=t.apply(r,e)).next())});var Pe={};Oe(Pe,{ViteWebfontDownload:()=>Be,default:()=>Be,viteWebfontDl:()=>Be,viteWebfontDownload:()=>Be,webfontDl:()=>Be,webfontDownload:()=>Be});module.exports=Le(Pe);var ue=require("http"),v=D(require("picocolors"));var fe=require("url"),ge=D(require("clean-css"));var E=class{constructor(e,t,s,n){this.options=e;this.logger=t;this.downloader=s;this.fileCache=n;this.isRelativeUrlRegex=/\.\.?\/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi;this.protocolRelativeUrlRegex=new RegExp("(?<!https?:)\\/\\/[-a-z0-9@:%_+.~#?&/=]+\\.(?:woff2?|eot|ttf|otf|svg)","gi")}loadAll(e,t){return d(this,null,function*(){let s="";for(let n of e){let a=yield this.load(n),l=this.normalizeUrls(a.trim(),n);s+=l+`
`}return this.formatCss(s,t)})}formatCss(e,t){return!t&&this.options.minifyCss?this.minify(e):e.trim()}minify(e){return new ge.default().minify(e).styles}normalizeUrls(e,t){return e=e.replaceAll(this.isRelativeUrlRegex,s=>new fe.URL(s,t).href),e=e.replaceAll(this.protocolRelativeUrlRegex,s=>"https:"+s),e}load(e){return d(this,null,function*(){this.logger.flashLine(e);let t=this.fileCache.get("css",e);if(t)return t;let s=yield this.downloader.download(e,"text");return this.fileCache.save("css",e,s.data),s.data})}};var H=class{constructor(){this.fontSrcRegex=/(?:https?:)?\/\/[-a-z0-9@:%_+.~#?&/=]+\.(?:woff2?|eot|ttf|otf|svg)/gi;this.googleFontsKitSrcRegex=/https:\/\/fonts\.gstatic\.com\/l\/font\?kit=[a-z0-9&=_-]+/gi;this.fontFilenameRegex=/[^/]+\.(?:woff2?|eot|ttf|otf|svg)/i;this.googleFontsFileRegex=/\?kit=([a-z0-9_-]+)/i;this.webfontProviders=[/https:\/\/fonts\.googleapis\.com\//i,/https:\/\/fonts\.gstatic\.com\//i,/https:\/\/fonts\.bunny\.net\//i,/https:\/\/api\.fontshare\.com\//i]}parse(e,t,s){var u,p;let n={},a=e.matchAll(this.fontSrcRegex),l=e.matchAll(this.googleFontsKitSrcRegex);if(a)for(let f of a){let x=f.toString(),h=x.match(this.fontFilenameRegex);if(h){let w=h[0];n[w]={url:x,localPath:t+(s?s+"/":"")+w}}}if(l)for(let f of l){let x=f.toString(),h=(p=(u=x.match(this.googleFontsFileRegex))==null?void 0:u[1])==null?void 0:p.toString();h&&(n[h+".woff2"]={url:x,localPath:t+(s?s+"/":"")+h+".woff2"})}return n}parseBundleCss(e,t,s){let n={},a=new Set([]),l=[],u=/@import\s*(?:url\()?['"]?([^\s'"]+)['"]?\)?;/g,p=/@font-face\s*{[^}]*}/g,f=[...e.matchAll(u)];return[...e.matchAll(p)].forEach(h=>{let w=h[0],R=this.parse(w,t,s);for(let j in R){let O=R[j];this.webfontProviders.some(z=>z.test(O.url))&&(n[j]=O,l.push(h[0]))}}),f.forEach(h=>{let w=h[1];this.webfontProviders.some(R=>R.test(w))&&(a.add(w),l.push(h[0]))}),{fonts:n,webfontUrlsCss:a,matchedCssParts:l}}};var U=class{constructor(e){this.options=e}injectAsStylesheet(e,t,s){return this.options.async?this.injectAsync(e,t,s):this.injectSync(e,t,s)}injectAsStyleTag(e,t){return this.options.minifyCss?e.replace(/(\n?)([ \t]*)<\/head>/,`$1$2$2<style>${t}</style>$1$2</head>`):e.replace(/([ \t]*)<\/head>/,`$1$1<style>
${t.replace(/^/gm,"$1$1$1")}
$1$1</style>
$1</head>`)}injectAsync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" media="print" onload="this.onload=null;this.removeAttribute('media');" href="${t}${s}">
$1</head>`)}injectSync(e,t,s){return e.replace(/([ \t]*)<\/head>/,`$1$1<link rel="preload" as="style" href="${t}${s}">
$1$1<link rel="stylesheet" href="${t}${s}">
$1</head>`)}};var I=class{transform(e,t){for(let s in t){let n=t[s];e=e.replaceAll(n.url,n.localPath)}return e}};var q=require("axios"),pe=require("http"),he=require("https"),W=D(require("picocolors"));var K=class{constructor(e,t){this.options=e;this.logger=t;this.userAgentWoff2="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36";this.maxTries=3;this.timeout=2500;this.waitBeforeRetry=[25,2500];this.axios=new q.Axios({timeout:this.timeout,proxy:this.options.proxy,httpAgent:new pe.Agent({keepAlive:!0,family:4}),httpsAgent:new he.Agent({keepAlive:!0,family:4})})}download(e,t,s=1){return d(this,null,function*(){try{let n=yield this.toRequest(e,t);return s>1&&this.logger.info(W.default.green(`\u2713 ${e}`)+" "+W.default.dim(`(try #${s})`)),n}catch(n){if(this.logger.error(W.default.red(`\u2717 ${e}`)+" "+W.default.dim(`(try #${s})`)+": "+((0,q.isAxiosError)(n)?n.message:n)),s<this.maxTries)return yield new Promise(a=>setTimeout(a,this.randomWaitInterval())),this.download(e,t,s+1);throw n}})}toRequest(e,t){return this.axios.get(e,{headers:{"User-Agent":this.userAgentWoff2},responseType:t||"arraybuffer"})}randomWaitInterval(){return Math.floor(Math.random()*(this.waitBeforeRetry[0]-this.waitBeforeRetry[1]+1)+this.waitBeforeRetry[1])}};var N=class{constructor(e,t,s){this.logger=e;this.downloader=t;this.fileCache=s}load(e){return d(this,null,function*(){this.logger.flashLine(e);let t=this.fileCache.get("font",e);if(t)return t;let s=yield this.downloader.download(e);return this.fileCache.save("font",e,s.data),s.data})}};var M=D(require("flat-cache")),V=class{constructor(e){this.enabled=!0;this.hits={css:0,font:0};e.cache===!1&&(this.enabled=!1),this.storeCss=M.default.create("vite-plugin-webfont-dl__css"),this.storeFont=M.default.create("vite-plugin-webfont-dl__font"),this.enabled||this.clear()}get(e,t){if(!this.enabled)return;let s=e==="css"?this.storeCss.getKey(t):this.storeFont.getKey(t);if(s)return e==="css"?this.hits.css++:this.hits.font++,s.type!==void 0?Buffer.from(s.data):s}save(e,t,s){this.enabled&&(e==="css"?(this.storeCss.setKey(t,s),this.storeCss.save(!0)):(this.storeFont.setKey(t,s),this.storeFont.save(!0)))}clear(){M.default.clearCacheById("vite-plugin-webfont-dl__css"),M.default.clearCacheById("vite-plugin-webfont-dl__font")}};var _=class{constructor(){this.webfontRegexes=[/<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\/\/fonts\.googleapis\.com[^'">]+)['"]?[^>]*>/g,/<link[^>]+href=['"]?(https:\/\/fonts\.googleapis\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>/g,/<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\/\/fonts\.bunny\.net[^'">]+)['"]?[^>]*>/g,/<link[^>]+href=['"]?(https:\/\/fonts\.bunny\.net[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>/g,/<link[^>]+rel=['"]?stylesheet['"]?[^>]+href=['"]?(https:\/\/api\.fontshare\.com[^'">]+)['"]?[^>]*>/g,/<link[^>]+href=['"]?(https:\/\/api\.fontshare\.com[^'">]+)['"]?[^>]+rel=['"]?stylesheet['"]?[^>]*>/g];this.preconnectRegexes=[/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.googleapis\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.gstatic\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/fonts\.bunny\.net['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/,/<link[^>]+rel=['"]?preconnect['"]?[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]*>/,/<link[^>]+href=['"]?https:\/\/api\.fontshare\.com['"]?[^>]+rel=['"]?preconnect['"]?[^>]*>/]}parse(e){let t=new Set;for(let s of this.webfontRegexes){let n=e.matchAll(s);if(n)for(let a of n)t.add(a[1])}return t}removeTags(e){return e=this.removePreconnectTags(e),e=this.removeWebfontTags(e),e}removePreconnectTags(e){for(let t of this.preconnectRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}removeWebfontTags(e){for(let t of this.webfontRegexes){let s=new RegExp("[ 	]*"+t.source+`(\r
|\r|
)?`,"g");e=e.replace(s,"")}return e}};var b=require("process"),me=D(require("picocolors")),X=class{setResolvedLogger(e){this.resolvedLogger=e}isTty(){return b.stdout.isTTY&&!b.env.CI}info(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.info((t?this.prefix():"")+e)}error(e,t=!0){var s;this.clearLine(),(s=this.resolvedLogger)==null||s.error((t?this.prefix():"")+e)}clearLine(){this.isTty()&&(b.stdout.clearLine(0),b.stdout.cursorTo(0))}flashLine(e,t=!0){this.isTty()?(this.clearLine(),e=(t?this.prefix():"")+e,e.length<b.stdout.columns?b.stdout.write(e):b.stdout.write(e.substring(0,b.stdout.columns-1)),this.flashTimeout&&clearTimeout(this.flashTimeout),this.flashTimeout=setTimeout(()=>{this.clearLine()},500)):this.info(e,t)}prefix(){return me.default.dim("[webfont-dl] ")}};var ke={injectAsStyleTag:!0,minifyCss:!0,async:!0,cache:!0,proxy:!1},de=(r={})=>F(F({},ke),r);var ve=require("axios");function Be(r,e){!Array.isArray(r)&&typeof r!="string"&&(r=[]),typeof r=="string"&&r!==""&&(r=[r]);let t=new Set(r||[]),s=new Set([]),n=new Set([]),a=de(e),l={},u="webfonts.css",p=new Map,f=new X,x=new K(a,f),h=new V(a),w=new E(a,f,x,h),R=new H,j=new I,O=new U(a),z=new N(f,x,h),G=new _,C,Y,L,A,S,y="",k,B=new Map,J=o=>{for(let i of G.parse(o))s.add(i)},ye=()=>{s.clear(),B.forEach(o=>{J(o)})},we=o=>{n.clear();for(let i in o)if(i.match(/\.css$/)){let g=o[i].source.toString(),m=R.parseBundleCss(g,A,S);m.matchedCssParts.length&&(l=F(F({},l),m.fonts),m.webfontUrlsCss.forEach(c=>{n.add(c)}),m.matchedCssParts.forEach(c=>{g=g.replaceAll(c,""),y+=c+`
`}),o[i].source=g,y=w.formatCss(y,!!C))}},Q=()=>d(this,null,function*(){y="";let o=Date.now(),i=new Set([...t,...s,...n]);return i.size&&(y+=yield w.loadAll(i,!!C)),C||f.info(v.default.green("\u2713")+" "+i.size.toString()+" webfont css downloaded. "+v.default.dim("("+v.default.bold(re(o))+", "+(a.cache!==!1?`cache hit: ${v.default.bold(oe(h.hits.css,i.size))}`:"cache disabled")+")"),!1),y}),Z=o=>{l=F(F({},l),R.parse(o,A,S))},ee=()=>{y=j.transform(y,l)},be=()=>d(this,null,function*(){let o=Date.now();for(let i in l){let g=l[i],m=yield z.load(g.url);g.localPath=A+te(i,m)}f.info(v.default.green("\u2713")+" "+Object.keys(l).length.toString()+" webfonts downloaded. "+v.default.dim("("+v.default.bold(re(o))+", "+(a.cache!==!1?`cache hit: ${v.default.bold(oe(h.hits.font,Object.keys(l).length))}`:"cache disabled")+")"),!1)}),xe=o=>d(this,null,function*(){let i=z.load(o);return f.clearLine(),i}),Ce=()=>d(this,null,function*(){Z(yield Q()),ee(),p.clear();for(let o in l){let i=l[o];p.set(i.localPath,i.url)}}),Fe=()=>{k=te(u,y)},te=(o,i)=>{let g=Y.emitFile({name:o,type:"asset",source:i});return Y.getFileName(g)},se=(o,i)=>C||a.injectAsStyleTag===!1?O.injectAsStylesheet(o,A,k):O.injectAsStyleTag(o,i),re=o=>(Date.now()-o).toLocaleString()+" ms",oe=(o,i)=>(Math.round(o/i*100*100)/100).toFixed(2)+"%";return{name:"vite-plugin-webfont-dl",enforce:"post",configResolved(o){L=o,A=L.base,S=L.build.assetsDir,k=S+"/"+u,L.build.minify===!1&&(e==null?void 0:e.minifyCss)!==!0&&(a.minifyCss=!1),f.setResolvedLogger(L.logger)},configureServer(o){C=o,S="@webfonts",k=S+"/"+u;let i=(m,c)=>{d(this,null,function*(){c.setHeader("Content-Type","text/css");try{yield Ce(),c.end(y)}catch($){f.error(v.default.red($.message)),c.statusCode=502,c.setHeader("X-Error",$.message.replace(/^Error: /,"")),c.end()}})},g=(m,c)=>{d(this,null,function*(){var T;let $=(T=m.originalUrl)==null?void 0:T.replace(/[?#].*$/,"");c.setHeader("Access-Control-Allow-Origin","*"),c.end(yield xe(p.get($)))})};C.middlewares.use(A+k,i),C.middlewares.use(A+u,i),C.middlewares.use((m,c,$)=>{var ne;let T=(ne=m.originalUrl)==null?void 0:ne.replace(/[?#].*$/,"");if(!T)return $();T.match(/\.(?:woff2?|eot|ttf|otf|svg)$/)&&p.has(T)?g(m,c):$()})},transformIndexHtml(o,i){return B.set(i.path.replace(/^\//,""),o),C&&(s.clear(),J(o),o=G.removeTags(o),o=se(o)),o},generateBundle(o,i){return d(this,null,function*(){Y=this,ye(),we(i);try{Z(yield Q()),yield be(),ee(),(a.injectAsStyleTag===!1||!B.size)&&Fe(),B.forEach((g,m)=>{let c=i[m];c!==void 0&&(c.source=G.removeTags(c.source),c.source=se(c.source,y),B.set(m,c.source))})}catch(g){f.error(v.default.red(g.message)),g instanceof ve.AxiosError&&g.request instanceof ue.ClientRequest&&f.error(v.default.red(`${g.request.method} ${g.request.protocol}//${g.request.host}${g.request.path}`))}})}}}0&&(module.exports={ViteWebfontDownload,viteWebfontDl,viteWebfontDownload,webfontDl,webfontDownload});
